

<!DOCTYPE html>
<html lang="en">
<head>

    </style>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.49.0.min.js" type="text/javascript"></script>
    <title>IoT demo</title>

    <!-- Load resources statically, or dynamically as below
    <base href="https://s3.amazonaws.com/virtual-concierge-amplify-us-east-1/">
    -->
    <link href="css/scene-style.css" type="text/css" rel="stylesheet">
    <script src="script/scene-format.js" type="text/javascript"></script>

    <script type="text/javascript">

      var IdentityPoolId = "ap-southeast-2:a88175a2-9025-4baa-a023-5202c14ee7cb";
      var Region = "ap-southeast-2";
      var ThingName = "deeplens_zz8BbGbNSVuHCsyqtWOM4Q"; // TODO: Read from device state

      AWS.config.region = Region;
      AWS.config.credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: IdentityPoolId
      });

      AWS.config.credentials.get(function (err) {
        if(err) {
            console.log(err);
            return
        }

        console.log("updated aws config with web identity federation:\n", AWS.config.credentials);
        AWS.config.identityId = AWS.config.credentials.identityId;
        console.log("identityId:", AWS.config.identityId);
      });
    </script>

    <script type="text/javascript">

        function getUrlParams(search) {
            var hashes = search.slice(search.indexOf('?') + 1).split('&')
            var params = {}
            hashes.map(hash => {
                let [key, val] = hash.split('=')
                params[key] = decodeURIComponent(val)
            })
            return params
        }

        function renderScene() {
          console.log('onload')

          // Get the settings from query string
          var settings = Object.assign({
            theme: "default",
            ip: "192.168.6.160",
            thingName: "deeplens_zz8BbGbNSVuHCsyqtWOM4Q",
            sqsUrl: "https://sqs.us-west-2.amazonaws.com/882607831196/SumerianMessageQueue.fifo",
            baseUrl: "./"
          }, getUrlParams(window.location.search))

          // Update the body theme and set cam and logo
          var format = new SceneFormat(settings)
          document.body.classList.add(settings['theme']);
          document.getElementById("cam").innerHTML = format.camHtml()
          document.getElementById("logo").innerHTML = format.logoHtml()

          // Populate the dynamic html elements
          var props = {
            MessageType: "hostArrived",
            PhotoUrl: "./photo/julbrigh_r0.jpg",
            OrientationCorrection: "ROTATE_0",
            Name: "Julian Bright",
            Host: "Ed Lima",
            Place: "Tech Shift Melbourne",
            VisitorArrivedAt: 1541570056, // Epoch seconds
            HostArrivingIn: 120, // Estimated time to arrive in seconds
            HostArrivedAt: 1541571057 // Epoch seconds
          }
          document.getElementById("screen").innerHTML = format.screenHtml(props)

          // console.log('speak', format.speakSsml(props))

          var polly = new AWS.Polly();
          var params = {
            OutputFormat: "mp3",
            SampleRate: "8000",
            Text: format.speakSsml(props),
            TextType: "ssml",
            VoiceId: "Amy"
           };
           polly.synthesizeSpeech(params, function(err, data) {
             if (err) {
                console.log(err, err.stack); // an error occurred
               return
             }
             // Update audio element to play
             var uInt8Array = new Uint8Array(data.AudioStream);
             var arrayBuffer = uInt8Array.buffer;
             var blob = new Blob([arrayBuffer]);
             var url = URL.createObjectURL(blob);
             audioElement = document.getElementById("audio")
             audioElement.src = url;
           });
        }

        // Wire up the window on load function
        window.onload=renderScene

    </script>

    <style>

    #screen, #cam, #qrcode {
      width: 1280px;
      height: 629px;
      background-color: #ddd; /* Make this different from background */
    }
    #logo {
      width: 400px;
      height: 280px;
    }

    </style>

</head>
<body class="standard-theme">
  <h2>Play Audio</h2>
  <audio id="audio" controls>Your browser doesn't support audio</audio>
  <h2>QR Code</h2>
  <div id="qrcode">
    <div class="qrcode"/>
  </div>
  <h2>Screen</h2>
  <div id="screen">
    <div id="photo">
      <img class="photo" src="#"></img>
    </div>
    <div id="message">
      <div class="message"></div>
    </div>
  </div>
  <h2>Cam</h2>
  <div id="cam">
    <img class="cam" src="#"></img>
  </div>
  <h2>Logo</h2>
  <div id="logo">
    <div class="logo"/>
  </div>
</body>
</html>
